<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mini-arÃ¨ne (prototype)</title>
<style>
  html,body { height:100%; margin:0; background:#111; color:#eee; font-family:Arial,Helvetica,sans-serif; }
  #gameWrap{ display:flex; height:100vh; align-items:center; justify-content:center; position:relative; }
  canvas { background:#2b7; border:6px solid #222; box-shadow:0 6px 30px rgba(0,0,0,0.6); }
  .ui {
    position:absolute; right:18px; bottom:18px; z-index:20; display:flex; flex-direction:column; gap:8px;
  }
  .btn {
    background:#0b84ff; color:white; border:none; padding:10px 14px; border-radius:8px; cursor:pointer;
    font-weight:700; box-shadow:0 4px 14px rgba(11,132,255,0.35);
  }
  .panel {
    position:absolute; left:18px; top:18px; background:rgba(0,0,0,0.55); padding:12px; border-radius:8px;
    min-width:220px; color:#fff;
  }
  .row { margin:6px 0; }
  label{display:block; font-size:13px; margin-bottom:6px;}
  select,input[type=color],input[type=text] { width:100%; padding:6px; border-radius:6px; border:1px solid #444; background:#222; color:#fff;}
  #overlayScreen {
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center; z-index:30;
    pointer-events:none;
  }
  .screenBox {
    pointer-events:auto;
    background:rgba(10,10,10,0.9); color:#fff; padding:24px; border-radius:10px; text-align:center; width:min(600px,90%);
    box-shadow:0 10px 40px rgba(0,0,0,0.7);
  }
  .screenBox h1{ margin:0 0 12px; font-size:28px; }
  .hud {
    position:absolute; left:50%; transform:translateX(-50%); top:12px; z-index:25; color:#fff; text-align:center;
  }
  .barWrap { width:260px; height:14px; background:#333; border-radius:8px; overflow:hidden; margin:0 auto; border:1px solid #222;}
  .bar { height:100%; background:linear-gradient(90deg,#00d08a,#00a68f); width:100%; }
  .infoRow{display:flex; gap:12px; justify-content:center; margin-top:8px; font-size:14px;}
  .small { font-size:12px; opacity:0.9; }
  .leaderboard { margin-top:8px; background:#111; padding:8px; border-radius:6px; border:1px solid #222; max-height:150px; overflow:auto; font-size:13px;}
  .lb-row{ display:flex; justify-content:space-between; padding:4px 6px; border-bottom:1px solid #222; }
</style>
</head>
<body>
<div id="gameWrap">
  <canvas id="c" width="1000" height="600"></canvas>

  <!-- left panel: choix skin/arme + pseudo + leaderboard -->
  <div class="panel" id="panel">
    <div class="row">
      <label>Pseudo</label>
      <input type="text" id="pseudoInput" placeholder="Ton pseudo">
      <button class="btn" id="savePseudoBtn" style="margin-top:8px;">Sauvegarder pseudo</button>
    </div>

    <div class="row">
      <label>Choisir le skin (aperÃ§u simple)</label>
      <select id="skinSelect">
        <option value="0">Skin Bleu (par dÃ©faut)</option>
        <option value="1">Skin Rouge</option>
        <option value="2">Skin Vert</option>
        <option value="3">Skin Jaune</option>
      </select>
    </div>
    <div class="row">
      <label>Choisir l'arme</label>
      <select id="weaponSelect">
        <option value="pistol">Pistolet</option>
        <option value="shotgun">Pompe</option>
        <option value="sniper">Sniper</option>
        <option value="smg">Mitraillette</option>
      </select>
    </div>

    <div class="row small">DÃ©placements AZERTY: <strong>Z Q S D</strong> â€¢ Tir: <strong>Clic gauche</strong> â€¢ Recharger: <strong>R</strong></div>

    <div class="row">
      <label>Classement (couronnes)</label>
      <div class="leaderboard" id="leaderboard"></div>
    </div>
  </div>

  <!-- HUD center top -->
  <div class="hud" id="hud">
    <div class="barWrap"><div id="hpBar" class="bar" style="width:100%"></div></div>
    <div class="infoRow">
      <div id="hpText">Vie: 10 / 10</div>
      <div id="ammoText">Ammo: 10 / 10</div>
      <div id="roundText">Round: 0 / 3</div>
    </div>
  </div>

  <!-- bottom-right UI -->
  <div class="ui">
    <button id="joinBtn" class="btn">Simuler 2Ã¨me joueur</button>
    <button id="toggle2PBtn" class="btn">Activer mode 2 joueurs local</button>
    <button id="playBtn" class="btn">JOUER</button>
  </div>

  <!-- overlay screens -->
  <div id="overlayScreen"></div>
</div>

<script>
/* --------------------------
   Prototype ArÃ¨ne 2D (prototype Ã©tendu)
   - Modifs demandÃ©es ajoutÃ©es :
     * toutes les armes = 1 dÃ©gÃ¢t
     * player & bots = 10 HP
     * toutes les 5 balles tirÃ©es -> reload automatique 3s
     * distance limite pour les armes
     * match = best of 3 rounds (3 rounds max)
     * +10 couronnes au gagnant du match (classement local)
   - J'ai ajoutÃ© pseudo + leaderboard local (localStorage)
   - Ajout: mode 2 joueurs sur le mÃªme Ã©cran, activable
   -------------------------- */

const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');

let W = canvas.width, H = canvas.height;

// Game state
let game = {
  running:false,
  roundStartTime:0,
  bgColor:'#2b7',
  players:[],
  enemies: [],
  bullets: [],
  roundWinner:null,
  lobbySimulated:false,
  local2P:false, // mode 2 joueurs local
  // match state:
  match: {
    roundsPerMatch: 3,
    currentRound: 0,
    playerRoundWins: 0,
    enemyRoundWins: 0
  }
};

// Settings UI
const skinSelect = document.getElementById('skinSelect');
const weaponSelect = document.getElementById('weaponSelect');
const playBtn = document.getElementById('playBtn');
const joinBtn = document.getElementById('joinBtn');
const toggle2PBtn = document.getElementById('toggle2PBtn');
const overlayScreen = document.getElementById('overlayScreen');
const hudHpBar = document.getElementById('hpBar');
const hpText = document.getElementById('hpText');
const ammoText = document.getElementById('ammoText');
const roundText = document.getElementById('roundText');

const pseudoInput = document.getElementById('pseudoInput');
const savePseudoBtn = document.getElementById('savePseudoBtn');
const leaderboardEl = document.getElementById('leaderboard');

function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function randChoice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function rnd(min,max){ return Math.random()*(max-min)+min; }

const PLAYER_SIZE = 44;
const ENEMY_SIZE = 44;

// Controls (AZERTY + arrows for 2P)
const keys = { z:false,q:false,s:false,d:false, r:false, up:false,down:false,left:false,right:false };
window.addEventListener('keydown',(e)=>{
  const k=e.key.toLowerCase();
  if(k==='z') keys.z=true;
  if(k==='q') keys.q=true;
  if(k==='s') keys.s=true;
  if(k==='d') keys.d=true;
  if(k==='r') keys.r=true;
  if(k==='arrowup') keys.up=true;
  if(k==='arrowdown') keys.down=true;
  if(k==='arrowleft') keys.left=true;
  if(k==='arrowright') keys.right=true;
});
window.addEventListener('keyup',(e)=>{
  const k=e.key.toLowerCase();
  if(k==='z') keys.z=false;
  if(k==='q') keys.q=false;
  if(k==='s') keys.s=false;
  if(k==='d') keys.d=false;
  if(k==='r') keys.r=false;
  if(k==='arrowup') keys.up=false;
  if(k==='arrowdown') keys.down=false;
  if(k==='arrowleft') keys.left=false;
  if(k==='arrowright') keys.right=false;
});

// Mouse aim & click
let mouse = { x:W/2, y:H/2, down:false };
canvas.addEventListener('mousemove', e=>{
  const rect = canvas.getBoundingClientRect();
  mouse.x = e.clientX - rect.left;
  mouse.y = e.clientY - rect.top;
});
canvas.addEventListener('mousedown', e=>{ if(e.button===0) mouse.down = true; });
canvas.addEventListener('mouseup', e=>{ if(e.button===0) mouse.down = false; });

// Basic weapon definitions
const WEAPONS = {
  pistol: { name:'Pistolet', mag:10, fireRate: 300, bulletSpeed:700, dmg:1, reloadTime:900, spread:6, range:800 },
  shotgun: { name:'Pompe', mag:6, fireRate:900, bulletSpeed:600, dmg:1, pellets:6, pelletSpread:18, reloadTime:1400, range:220 },
  sniper: { name:'Sniper', mag:1, fireRate:2000, bulletSpeed:1200, dmg:1, reloadTime:1800, scope:true, range:1400 },
  smg: { name:'Mitraillette', mag:30, fireRate:80, bulletSpeed:900, dmg:1, reloadTime:1100, spread:8, range:900 }
};

// Player constructor
function createPlayer(id='p1', x=W/2, y=H/2){
  const skin = parseInt(skinSelect.value,10)||0;
  const weaponKey = weaponSelect.value || 'pistol';
  const weapon = Object.assign({}, WEAPONS[weaponKey]);
  weapon.key = weaponKey;
  weapon.ammo = weapon.mag;
  weapon.shotsSinceAutoReload = 0;
  return {
    id,
    x, y,
    vx:0, vy:0,
    size:PLAYER_SIZE,
    speed:200,
    hp:10,
    maxHp:10,
    skin,
    weapon,
    canFire:true,
    lastFire:0,
    reloading:false,
    alive:true
  };
}

// Enemy AI (unchanged)
function createEnemy(i){
  const wkey = randChoice(['pistol','shotgun','smg']);
  const w = Object.assign({}, WEAPONS[wkey]);
  w.key = wkey;
  w.ammo = w.mag;
  w.shotsSinceAutoReload = 0;
  return {
    id:'e'+i,
    x: randInt(80, W-80),
    y: randInt(80, H-80),
    size:ENEMY_SIZE,
    speed: 120,
    hp:10,
    maxHp:10,
    state:'patrol',
    targetPoint: null,
    reactionTime: rnd(300,1200),
    lastSeeTime:0,
    lastAction:0,
    weapon: w,
    alive:true,
    aimNoise: rnd(3,10)
  };
}

// bullets
function spawnBullet(x,y,dx,dy,owner,weaponKey,dmg, maxRange){
  game.bullets.push({ x,y,vx:dx, vy:dy, owner, dmg, life:2000, weaponKey, ox:x, oy:y, maxRange:maxRange||1000 });
}

// Start Round
function startRound(){
  if(game.match.currentRound === 0){
    game.match.playerRoundWins = 0;
    game.match.enemyRoundWins = 0;
  }
  game.match.currentRound++;
  game.bullets = [];
  game.enemies = [];
  game.players = [];
  game.roundWinner = null;
  game.roundStartTime = performance.now();
  game.bgColor = `hsl(${randInt(0,360)} ${randInt(40,70)}% ${randInt(35,55)}%)`;

  // player 1
  const p1 = createPlayer('p1', W/2, H/2);
  game.players.push(p1);

  // player 2 if local2P
  if(game.local2P){
    const p2 = createPlayer('p2', W/2, H/2 + 60);
    game.players.push(p2);
  }

  // spawn 1 enemy
  for(let i=0;i<1;i++) game.enemies.push(createEnemy(i+1));

  game.running = true;
  overlayScreen.innerHTML = '';
  updateHUD();
}

// Toggle local 2P
toggle2PBtn.addEventListener('click', ()=>{
  game.local2P = !game.local2P;
  toggle2PBtn.textContent = game.local2P ? 'Mode 2 joueurs activÃ©' : 'Activer mode 2 joueurs local';
});

// Simulate second player button (unchanged)
joinBtn.addEventListener('click', ()=>{
  game.lobbySimulated = !game.lobbySimulated;
  joinBtn.textContent = game.lobbySimulated ? '2Ã¨me joueur prÃ©sent (simulÃ©)' : 'Simuler 2Ã¨me joueur';
});

// Play button
playBtn.addEventListener('click', ()=>{
  if(game.lobbySimulated || game.local2P){
    startRound();
  } else {
    showOverlayMessage('En attente dâ€™un autre joueurâ€¦ (simulation)', 1500, startRound);
  }
});

// Overlay helper
function showOverlayMessage(msg, ms, cb){
  overlayScreen.innerHTML = `<div class="screenBox"><h1>${msg}</h1></div>`;
  setTimeout(()=>{ overlayScreen.innerHTML=''; if(cb) cb(); }, ms);
}

// Main loop
let lastTime = performance.now();
function loop(now){
  const dt = Math.min(50, now-lastTime)/1000;
  lastTime = now;
  update(dt);
  render();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

// HUD, leaderboard helpers (unchanged)
function getSavedPseudo(){ return localStorage.getItem('mini_arena_pseudo') || ''; }
function savePseudo(name){ if(!name) return; localStorage.setItem('mini_arena_pseudo', name); if(!getCrownsFor(name)) setCrownsFor(name,0); refreshLeaderboard(); }
function getCrownsFor(name){ const v = localStorage.getItem('mini_arena_crowns_'+name); return v?parseInt(v,10):0; }
function setCrownsFor(name,n){ localStorage.setItem('mini_arena_crowns_'+name,String(n)); }
function addCrownsTo(name,add){ setCrownsFor(name,(getCrownsFor(name)||0)+add); }
function refreshLeaderboard(){
  const list=[];
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(k && k.startsWith('mini_arena_crowns_')){
      const name = k.replace('mini_arena_crowns_','');
      const crowns = parseInt(localStorage.getItem(k),10) || 0;
      list.push({name,crowns});
    }
  }
  list.sort((a,b)=>b.crowns - a.crowns);
  leaderboardEl.innerHTML='';
  if(list.length===0) leaderboardEl.innerHTML='<div class="small">Aucun joueur pour lâ€™instant</div>';
  list.forEach(it=>{
    const row = document.createElement('div'); row.className='lb-row';
    row.innerHTML = `<div>${escapeHtml(it.name)}</div><div>${it.crowns} ðŸ‘‘</div>`;
    leaderboardEl.appendChild(row);
  });
}
function escapeHtml(s){ return String(s).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

savePseudoBtn.addEventListener('click', ()=>{
  const name = pseudoInput.value.trim();
  if(!name) return alert('Entre un pseudo valide');
  savePseudo(name);
  alert('Pseudo sauvegardÃ©: '+name);
});

// Update HUD
function updateHUD(){
  const p = game.players[0];
  if(!p) return;
  const pct = Math.max(0,p.hp/p.maxHp)*100;
  hudHpBar.style.width = pct+'%';
  hpText.textContent = `Vie: ${p.hp} / ${p.maxHp}`;
  ammoText.textContent = `Ammo: ${p.weapon.ammo} / ${p.weapon.mag}`;
  roundText.textContent = `Round: ${game.match.currentRound} / ${game.match.roundsPerMatch}`;
}

/* ---------------------------
   Game update/render (player 2 included)
--------------------------- */
function update(dt){
  if(!game.running) return;
  // update all players
  game.players.forEach((p,i)=>{
    if(!p.alive) return;

    // input
    let moveX=0, moveY=0;
    if(p.id==='p1'){
      if(keys.z) moveY-=1;
      if(keys.s) moveY+=1;
      if(keys.q) moveX-=1;
      if(keys.d) moveX+=1;
      // shooting
      if(mouse.down && p.canFire && !p.reloading){
        fireWeapon(p, mouse.x, mouse.y);
      }
      if(keys.r) reloadWeapon(p);
    } else if(p.id==='p2'){
      if(keys.up) moveY-=1;
      if(keys.down) moveY+=1;
      if(keys.left) moveX-=1;
      if(keys.right) moveX+=1;
      if(mouse.down && p.canFire && !p.reloading){ fireWeapon(p, mouse.x, mouse.y); }
      if(keys.r) reloadWeapon(p);
    }

    const len = Math.hypot(moveX, moveY);
    if(len>0){ moveX/=len; moveY/=len; }
    p.x += moveX*p.speed*dt;
    p.y += moveY*p.speed*dt;

    // keep in canvas
    p.x = Math.max(p.size/2, Math.min(W-p.size/2, p.x));
    p.y = Math.max(p.size/2, Math.min(H-p.size/2, p.y));
  });

  // bullets
  for(let i=game.bullets.length-1;i>=0;i--){
    const b = game.bullets[i];
    b.x += b.vx*dt;
    b.y += b.vy*dt;
    b.life -= dt*1000;
    if(b.life<=0 || Math.hypot(b.x-b.ox,b.y-b.oy) > b.maxRange){
      game.bullets.splice(i,1);
      continue;
    }
    // check collision with players
    game.players.forEach(p=>{
      if(p.id===b.owner) return;
      if(!p.alive) return;
      const dx=p.x-b.x, dy=p.y-b.y;
      if(Math.hypot(dx,dy)<p.size/2){
        p.hp-=b.dmg;
        if(p.hp<=0) p.alive=false;
        game.bullets.splice(i,1);
      }
    });
  }

  updateHUD();
}

function render(){
  // clear
  ctx.fillStyle=game.bgColor;
  ctx.fillRect(0,0,W,H);

  // players
  game.players.forEach(p=>{
    ctx.fillStyle=['#00f','#f00','#0f0','#ff0'][p.skin]||'#00f';
    if(!p.alive) ctx.globalAlpha=0.3;
    ctx.beginPath();
    ctx.arc(p.x,p.y,p.size/2,0,2*Math.PI);
    ctx.fill();
    ctx.globalAlpha=1;
  });

  // bullets
  ctx.fillStyle='#fff';
  game.bullets.forEach(b=>{
    ctx.beginPath();
    ctx.arc(b.x,b.y,4,0,Math.PI*2);
    ctx.fill();
  });

  // enemies
  game.enemies.forEach(e=>{
    ctx.fillStyle='#0ff';
    ctx.beginPath();
    ctx.arc(e.x,e.y,e.size/2,0,Math.PI*2);
    ctx.fill();
  });
}

function fireWeapon(player, targetX, targetY){
  if(!player.canFire || player.reloading) return;
  const dx=targetX-player.x;
  const dy=targetY-player.y;
  const len = Math.hypot(dx,dy);
  const speed = player.weapon.bulletSpeed;
  const vx = dx/len*speed;
  const vy = dy/len*speed;
  spawnBullet(player.x,player.y,vx,vy,player.id,player.weapon.key,player.weapon.dmg,player.weapon.range);
  player.canFire=false;
  player.lastFire = performance.now();
  player.weapon.ammo--;
  player.weapon.shotsSinceAutoReload++;
  if(player.weapon.shotsSinceAutoReload>=5){
    reloadWeapon(player);
    player.weapon.shotsSinceAutoReload=0;
  }
  setTimeout(()=>{ player.canFire=true; }, player.weapon.fireRate);
}

function reloadWeapon(player){
  if(player.reloading) return;
  player.reloading = true;
  setTimeout(()=>{
    player.weapon.ammo = player.weapon.mag;
    player.reloading=false;
  }, player.weapon.reloadTime);
}
</script>
</body>
</html>
