<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Terraria RPG : Ultimate Online</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; background: #000; overflow: hidden; touch-action: none; font-family: 'Segoe UI', sans-serif; color: white; }
        canvas { display: none; image-rendering: pixelated; width: 100vw; height: 100vh; }

        /* --- MENU --- */
        #main-menu {
            position: absolute; width: 100%; height: 100%; 
            background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url('https://wallpaperaccess.com/full/1301405.jpg') center/cover;
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000;
        }
        .menu-box { background: rgba(20,20,20,0.95); padding: 30px; border-radius: 15px; border: 2px solid #00d4ff; text-align: center; width: 320px; box-shadow: 0 0 30px rgba(0,212,255,0.3); }
        input { padding: 10px; width: 85%; margin: 10px 0; border-radius: 5px; border: 1px solid #444; background: #111; color: white; text-align: center; }
        .btn-play { padding: 12px; background: #00d4ff; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        
        /* --- UI JEU --- */
        #game-ui { display: none; pointer-events: none; }
        #stats-overlay { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 8px; border-left: 4px solid #00d4ff; }
        #hp-bar { width: 150px; height: 10px; background: #333; margin: 5px 0; border-radius: 5px; overflow: hidden; }
        #hp-fill { width: 100%; height: 100%; background: #ff4444; }
        
        /* Inventaire & Craft */
        #hotbar { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; pointer-events: auto; }
        .slot { width: 50px; height: 55px; background: rgba(0,0,0,0.8); border: 2px solid #444; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 8px; cursor: pointer; }
        .slot.active { border-color: #00d4ff; background: rgba(0,212,255,0.2); }
        
        #craft-menu { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 8px; display: flex; flex-direction: column; gap: 5px; pointer-events: auto; max-height: 80vh; overflow-y: auto; width: 150px; }
        .recipe { background: #222; padding: 6px; border: 1px solid #444; font-size: 9px; cursor: pointer; }
        .recipe:hover { border-color: #00d4ff; }

        /* Controls Mobile */
        #joy-container { position: absolute; bottom: 40px; left: 40px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; display: none; touch-action: none; }
        #joy-knob { position: absolute; top: 30px; left: 30px; width: 40px; height: 40px; background: rgba(255,255,255,0.4); border-radius: 50%; }
        #jump-btn { position: absolute; bottom: 50px; right: 40px; width: 70px; height: 70px; background: rgba(255,255,255,0.1); border: 2px solid #fff; border-radius: 50%; display: none; align-items: center; justify-content: center; font-weight: bold; touch-action: none; pointer-events: auto; }
        
        @media (pointer: coarse) { #joy-container, #jump-btn { display: flex; } }
    </style>
</head>
<body>

    <div id="main-menu">
        <div class="menu-box">
            <h1 style="color: #00d4ff; margin: 0;">TERRARIA ULTIMATE</h1>
            <input type="text" id="pseudo-input" placeholder="Pseudo...">
            <button class="btn-play" onclick="initGame()">LANCER L'AVENTURE</button>
            <div style="text-align: left; margin-top: 15px;">
                <small>Amis :</small>
                <div id="friends-list" style="color: #4ade80; font-size: 11px;">Aucun ami</div>
            </div>
        </div>
    </div>

    <div id="game-ui">
        <div id="stats-overlay">
            <b id="display-name">Joueur</b><br>
            <div id="hp-bar"><div id="hp-fill"></div></div>
            <div id="inv-txt" style="font-size: 10px;"></div>
        </div>

        <div id="craft-menu">
            <b style="font-size: 10px; color: #00d4ff;">FORGE & CRAFT</b>
            <div class="recipe" onclick="craftItem('stick')">BÃ¢ton (1 Bois)</div>
            <div class="recipe" onclick="craftItem('arrow')">x5 FlÃ¨ches (1 BÃ¢t+1 Pierre)</div>
            <div class="recipe" onclick="craftTool('Pioche', 'pierre')">P. Pierre (2B+3P)</div>
            <div class="recipe" onclick="craftTool('Ã‰pÃ©e', 'fer')">E. Fer (1B+2F)</div>
            <div class="recipe" onclick="craftTool('Pioche', 'palladium')">P. PALLADIUM (2B+3Pa)</div>
        </div>

        <div id="hotbar">
            <div class="slot active" id="slot1" onclick="selectSlot(1)">Ã‰PÃ‰E</div>
            <div class="slot" id="slot2" onclick="selectSlot(2)">PIOCHE</div>
            <div class="slot" id="slot3" onclick="selectSlot(3)">HACHE</div>
            <div class="slot" id="slot4" onclick="selectSlot(4)">ARC</div>
        </div>
    </div>

    <div id="joy-container"><div id="joy-knob"></div></div>
    <div id="jump-btn">SAUT</div>
    <canvas id="game-canvas"></canvas>

<script>
const canvas = document.getElementById('game-canvas');
const ctx = canvas.getContext('2d', { alpha: false });
let world = [], entities = [], arrows = [], lastTime = 0;
let inBackrooms = false, jumpCounter = 0;
const TILE = 32, ROWS = 65, COLS = 120;

let player = { x: 1600, y: 700, w: 20, h: 38, vx: 0, vy: 0, hp: 100, grounded: false, name: "" };
let inv = { bois: 5, pierre: 0, fer: 0, or: 0, palladium: 0, batons: 10, fleches: 20 };
let tools = { 
    1: {type: 'Ã‰pÃ©e', mat: 'bois', power: 10}, 
    2: {type: 'Pioche', mat: 'bois', power: 1},
    3: {type: 'Hache', mat: 'bois', power: 1},
    4: {type: 'Arc', mat: 'bois', power: 15}
};
let activeSlot = 1, joyX = 0, keys = { q: false, d: false };

// --- GESTION PSEUDO ---
const pInput = document.getElementById('pseudo-input');
pInput.value = localStorage.getItem('t_pseudo') || "Player" + Math.floor(Math.random()*999);

function initGame() {
    player.name = pInput.value;
    localStorage.setItem('t_pseudo', player.name);
    document.getElementById('main-menu').style.display = 'none';
    document.getElementById('game-ui').style.display = 'block';
    canvas.style.display = 'block';
    document.getElementById('display-name').innerText = "ðŸ‘¤ " + player.name;
    
    // GÃ©nÃ©ration du monde avec minerais
    for(let y=0; y<ROWS; y++) {
        world[y] = [];
        for(let x=0; x<COLS; x++) {
            let id = 0;
            if(y === 30) id = 1; // Herbe
            else if(y > 30 && y < 35) id = 2; // Terre
            else if(y >= 35) {
                id = 3; // Pierre
                let r = Math.random();
                if(r < 0.06) id = 5; // Fer
                if(r < 0.02) id = 6; // Or
                if(y > 58 && r < 0.15) id = 9; // Palladium
            }
            world[y][x] = id;
        }
    }
    requestAnimationFrame(gameLoop);
}

// --- CRAFTING ---
function craftItem(type) {
    if(type === 'stick' && inv.bois >= 1) { inv.bois--; inv.batons += 4; }
    if(type === 'arrow' && inv.batons >= 1 && inv.pierre >= 1) { inv.batons--; inv.pierre--; inv.fleches += 5; }
    updateUI();
}

function craftTool(type, mat) {
    const costs = { Ã‰pÃ©e: 2, Pioche: 3, Hache: 3 };
    const sticks = (type === 'Ã‰pÃ©e') ? 1 : 2;
    const powerMult = { bois: 1, pierre: 2, fer: 4, or: 6, palladium: 10 };
    
    if(inv[mat] >= costs[type] && inv.batons >= sticks) {
        inv[mat] -= costs[type]; inv.batons -= sticks;
        let slot = (type === 'Ã‰pÃ©e') ? 1 : (type === 'Pioche' ? 2 : 3);
        tools[slot] = { type: type, mat: mat, power: powerMult[mat] };
        updateUI();
    }
}

// --- ENGINE ---
function gameLoop(timestamp) {
    const dt = Math.min((timestamp - lastTime) / 1000, 0.1);
    lastTime = timestamp;

    // Physique
    let move = joyX || (keys.d ? 1 : (keys.q ? -1 : 0));
    player.vx = move * 350;
    player.vy += 1500 * dt;
    player.x += player.vx * dt;
    player.y += player.vy * dt;

    // Collisions
    let gx = Math.floor(player.x/TILE), gy = Math.floor((player.y+player.h)/TILE);
    if(world[gy]?.[gx] > 0) {
        player.y = gy*TILE - player.h;
        player.vy = 0; player.grounded = true;
    } else player.grounded = false;

    // Backrooms
    if(!inBackrooms && gy >= ROWS-2 && jumpCounter >= 3) {
        inBackrooms = true;
        for(let y=0; y<ROWS; y++) for(let x=0; x<COLS; x++) world[y][x] = Math.random() > 0.9 ? 11 : 0;
    }

    draw();
    updateUI();
    requestAnimationFrame(gameLoop);
}

function draw() {
    let camX = player.x - canvas.width/2;
    let camY = player.y - canvas.height/2;
    ctx.fillStyle = inBackrooms ? "#ceca8d" : "#87CEEB";
    ctx.fillRect(0,0, canvas.width, canvas.height);

    for(let y=0; y<ROWS; y++) {
        for(let x=0; x<COLS; x++) {
            if(world[y][x] > 0) {
                const colors = {1:"#2d5a27", 2:"#5d4037", 3:"#555", 5:"#ddd", 6:"#ffd700", 9:"#ff4d00", 11:"#9e9a5e"};
                ctx.fillStyle = colors[world[y][x]];
                ctx.fillRect(x*TILE-camX, y*TILE-camY, TILE, TILE);
            }
        }
    }

    // FlÃ¨ches
    ctx.fillStyle = "white";
    arrows.forEach((arr, i) => {
        arr.x += arr.vx; arr.y += arr.vy; arr.vy += 0.2;
        ctx.fillRect(arr.x-camX, arr.y-camY, 8, 2);
        if(world[Math.floor(arr.y/TILE)]?.[Math.floor(arr.x/TILE)] > 0) arrows.splice(i, 1);
    });

    // Joueur
    ctx.fillStyle = "#00d4ff";
    ctx.fillRect(player.x-camX, player.y-camY, player.w, player.h);
    ctx.fillStyle = "white"; ctx.font = "10px Arial";
    ctx.fillText(player.name, player.x-camX, player.y-camY-5);
}

function updateUI() {
    document.getElementById('hp-fill').style.width = player.hp + "%";
    document.getElementById('inv-txt').innerText = `Bois:${inv.bois} Pierre:${inv.pierre} Fer:${inv.fer} Palla:${inv.palladium} FlÃ¨ches:${inv.fleches}`;
    for(let i=1; i<=4; i++) {
        document.getElementById('slot'+i).innerHTML = `<b style="color:#00d4ff">${tools[i].type}</b><br>${tools[i].mat}`;
    }
}

// --- CONTROLES ---
window.onkeydown = (e) => {
    let k = e.key.toLowerCase();
    if(k==='z' || k===' ') { if(player.grounded){ player.vy=-550; jumpCounter++; } }
    if(k==='q') keys.q = true; if(k==='d') keys.d = true;
};
window.onkeyup = (e) => { if(e.key==='q') keys.q=false; if(e.key==='d') keys.d=false; };

canvas.onmousedown = (e) => {
    let camX = player.x - canvas.width/2, camY = player.y - canvas.height/2;
    let mx = e.clientX + camX, my = e.clientY + camY;
    let gx = Math.floor(mx/TILE), gy = Math.floor(my/TILE);

    if(activeSlot === 2 && world[gy]?.[gx] > 0) { // Minage
        let id = world[gy][gx];
        if(id === 3) inv.pierre++; if(id === 5) inv.fer++; if(id === 6) inv.or++; if(id === 9) inv.palladium++;
        world[gy][gx] = 0;
    } else if(activeSlot === 4 && inv.fleches > 0) { // Tir
        let ang = Math.atan2(my-player.y, mx-player.x);
        arrows.push({x:player.x, y:player.y, vx:Math.cos(ang)*15, vy:Math.sin(ang)*15});
        inv.fleches--;
    }
    updateUI();
};

function selectSlot(n) { activeSlot = n; document.querySelectorAll('.slot').forEach((s,i)=>s.classList.toggle('active', i+1===n)); }

// Joystick Mobile
const jc = document.getElementById('joy-container'), jk = document.getElementById('joy-knob');
jc.addEventListener('touchmove', (e) => {
    let t = e.touches[0], r = jc.getBoundingClientRect();
    let dx = Math.max(-40, Math.min(40, t.clientX - (r.left+50)));
    jk.style.transform = `translateX(${dx}px)`; joyX = dx/40;
});
jc.addEventListener('touchend', () => { jk.style.transform=`translateX(0px)`; joyX=0; });
document.getElementById('jump-btn').addEventListener('touchstart', () => { if(player.grounded) player.vy=-550; });

canvas.width = window.innerWidth; canvas.height = window.innerHeight;
</script>
</body>
</html>
