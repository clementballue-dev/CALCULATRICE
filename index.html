<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Backrooms 2D - HTML5</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        canvas { display: block; background: #222; }
    </style>
</head>
<body>

<canvas id="jeu"></canvas>

<script>
const canvas = document.getElementById('jeu');
const ctx = canvas.getContext('2d');

// --- CONFIGURATION ---
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const T = 64; // Taille d'une tuile (64x64 pixels)
const TAILLE_ROOM = 8; // Chaque "pièce" fait 8x8 tuiles
let joueur = { x: 100, y: 100, v: 4 };
let monstre = { x: -100, y: -100, v: 2.5 };
let touches = {};
let monde = {}; // Stocke les pièces générées

// --- GENERATION DU LABYRINTHE ---
function obtenirPiece(cx, cy) {
    const cle = `${cx},${cy}`;
    if (!monde[cle]) {
        let grille = [];
        for (let y = 0; y < TAILLE_ROOM; y++) {
            grille[y] = [];
            for (let x = 0; x < TAILLE_ROOM; x++) {
                // Créer des murs sur les bords ou au hasard (20% de chance)
                let estMur = (x === 0 || x === TAILLE_ROOM-1 || y === 0 || y === TAILLE_ROOM-1) 
                             ? (Math.random() > 0.3) : (Math.random() < 0.15);
                grille[y][x] = estMur ? 1 : 0;
            }
        }
        // Toujours laisser des ouvertures pour circuler
        grille[0][Math.floor(TAILLE_ROOM/2)] = 0;
        grille[TAILLE_ROOM-1][Math.floor(TAILLE_ROOM/2)] = 0;
        monde[cle] = grille;
    }
    return monde[cle];
}

// --- LOGIQUE DE COLLISION ---
function peutMarcher(nx, ny) {
    let cx = Math.floor(nx / (T * TAILLE_ROOM));
    let cy = Math.floor(ny / (T * TAILLE_ROOM));
    let tx = Math.floor((nx % (T * TAILLE_ROOM) + (T * TAILLE_ROOM)) % (T * TAILLE_ROOM) / T);
    let ty = Math.floor((ny % (T * TAILLE_ROOM) + (T * TAILLE_ROOM)) % (T * TAILLE_ROOM) / T);
    
    let piece = obtenirPiece(cx, cy);
    return piece[ty][tx] === 0;
}

// --- BOUCLE DE JEU ---
function update() {
    let dx = 0, dy = 0;
    if (touches['ArrowUp'] || touches['z']) dy = -joueur.v;
    if (touches['ArrowDown'] || touches['s']) dy = joueur.v;
    if (touches['ArrowLeft'] || touches['q']) dx = -joueur.v;
    if (touches['ArrowRight'] || touches['d']) dx = joueur.v;

    // Collision Mur
    if (peutMarcher(joueur.x + dx, joueur.y)) joueur.x += dx;
    if (peutMarcher(joueur.x, joueur.y + dy)) joueur.y += dy;

    // IA Monstre (Le monstre te suit toujours)
    let dist = Math.hypot(joueur.x - monstre.x, joueur.y - monstre.y);
    if (dist > 5) {
        monstre.x += (joueur.x - monstre.x) / dist * monstre.v;
        monstre.y += (joueur.y - monstre.y) / dist * monstre.v;
    }

    if (dist < 30) {
        alert("L'ENTITÉ VOUS A EU...");
        joueur.x = 100; joueur.y = 100; // Reset
    }

    draw();
    requestAnimationFrame(update);
}

// --- DESSIN ---
function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    let offsetX = canvas.width / 2 - joueur.x;
    let offsetY = canvas.height / 2 - joueur.y;

    // Dessiner le monde (3x3 pièces visibles autour du joueur)
    let pcx = Math.floor(joueur.x / (T * TAILLE_ROOM));
    let pcy = Math.floor(joueur.y / (T * TAILLE_ROOM));

    for (let cx = pcx - 1; cx <= pcx + 1; cx++) {
        for (let cy = pcy - 1; cy <= pcy + 1; cy++) {
            let p = obtenirPiece(cx, cy);
            for (let y = 0; y < TAILLE_ROOM; y++) {
                for (let x = 0; x < TAILLE_ROOM; x++) {
                    let posX = (cx * TAILLE_ROOM + x) * T + offsetX;
                    let posY = (cy * TAILLE_ROOM + y) * T + offsetY;
                    
                    if (p[y][x] === 1) {
                        ctx.fillStyle = "#b4a050"; // Mur Jaune Backroom
                        ctx.fillRect(posX, posY, T, T);
                        ctx.strokeStyle = "#8a7a30";
                        ctx.strokeRect(posX, posY, T, T);
                    } else {
                        ctx.fillStyle = "#dcd296"; // Sol Tapis
                        ctx.fillRect(posX, posY, T, T);
                    }
                }
            }
        }
    }

    // Monstre (L'entité noire)
    ctx.fillStyle = "black";
    ctx.beginPath();
    ctx.ellipse(monstre.x + offsetX, monstre.y + offsetY, 20, 30, 0, 0, Math.PI * 2);
    ctx.fill();

    // Joueur
    ctx.fillStyle = "blue";
    ctx.fillRect(canvas.width / 2 - 15, canvas.height / 2 - 15, 30, 30);

    // EFFET LAMPE DE POCHE
    let gradient = ctx.createRadialGradient(
        canvas.width / 2, canvas.height / 2, 50, 
        canvas.width / 2, canvas.height / 2, 300
    );
    gradient.addColorStop(0, 'rgba(0,0,0,0)');
    gradient.addColorStop(1, 'rgba(0,0,0,0.95)');
    
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
}

// Contrôles
window.addEventListener('keydown', e => touches[e.key] = true);
window.addEventListener('keyup', e => touches[e.key] = false);

update();
</script>
</body>
</html>
